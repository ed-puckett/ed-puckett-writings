<!DOCTYPE html>
<html lang="en" xdata-cell-view="presentation" data-auto-render>
<head>
    <meta charset="utf-8">
    <script src="https://ed-puckett.github.io/bq/dist/v16.0/bq-bootstrap.js"></script>
</head>
<body>
<bq-cell data-type="javascript">
const cx = 150;
const cy = 100;
const tr = 30 /180*Math.PI;

const canvas = ocx.create_child({
    tag: 'canvas',
    attrs: { width: 300, height: 300 },
});

const ctx = canvas.getContext('2d');

ctx.strokeStyle = 'grey';

const a = 100, b = 70;

for (let t = 0; t < 2*Math.PI; t += 0.01) {
//    const x = a * Math.cos(t - tr) + cx
//    const y = b * Math.sin(t - tr) + cy

//    const r = a*b/Math.sqrt((b*Math.cos(t))**2 + (a*Math.sin(t))**2);
//    const x = r*Math.cos(t) + 110;
//    const y = r*Math.sin(t) + 110;

    const x = a*Math.cos(tr)*Math.cos(t) - b*Math.sin(tr)*Math.sin(t) + cx;
    const y = a*Math.sin(tr)*Math.cos(t) + b*Math.cos(tr)*Math.sin(t) + cy;

    canvas_tools.draw_dot(ctx, x, y);
}

</bq-cell>
<bq-cell data-type="markdown">
~~~! javascript
const { draw_hands } = await import_local('./hands.js');
const child_keys = ocx.create_child_mapping({
    children: [
        {
            tag: 'label',
            children: [
                'angle',
                {
                    _key: 'angle_control',
                    tag: 'input',
                    attrs: {
                        type: 'number',
                        value: 34,
                    },
                    style: {
                        'margin-left': '0.5em'
                    },
                },
            ],
        },
        { tag: 'br' },
        {
            tag: 'label',
            children: [
                'cx',
                {
                    _key: 'cx_control',
                    tag: 'input',
                    attrs: {
                        type: 'number',
                    },
                    style: {
                        'margin-left': '0.5em'
                    },
                },
                ' calculated: ',
                {
                    _key: 'cx_calculated_element',
                    tag: 'span',
                    style: {
                        'margin-left': '0.5em'
                    },
                },
            ],
        },
        { tag: 'br' },
        {
            tag: 'label',
            children: [
                'cy',
                {
                    _key: 'cy_control',
                    tag: 'input',
                    attrs: {
                        type: 'number',
                    },
                    style: {
                        'margin-left': '0.5em'
                    },
                },
                ' calculated: ',
                {
                    _key: 'cy_calculated_element',
                    tag: 'span',
                    style: {
                        'margin-left': '0.5em'
                    },
                },
            ],
        },
        { tag: 'br' },
        {
            tag: 'label',
            children: [
                {
                    _key: 'large_arc_control',
                    tag: 'input',
                    attrs: {
                        type: 'checkbox',
                    },
                },
                'large_arc',
            ],
        },
        { tag: 'br' },
        {
            tag: 'label',
            children: [
                {
                    _key: 'sweep_control',
                    tag: 'input',
                    attrs: {
                        type: 'checkbox',
                    },
                },
                'sweep',
            ],
        },
        { tag: 'br' },
        {
            tag: 'label',
            children: [
                {
                    _key: 'axes_control',
                    tag: 'input',
                    attrs: {
                        type: 'checkbox',
                        checked: true,
                    },
                },
                'axes',
            ],
        },
        { tag: 'br' },
        {
            tag: 'label',
            children: [
                {
                    _key: 'translated_axes_control',
                    tag: 'input',
                    attrs: {
                        type: 'checkbox',
                        checked: true,
                    },
                },
                'translated_axes',
            ],
        },
        { tag: 'br' },
        {
            tag: 'label',
            _key: 'info_element',
            style: {
                'whitespace': 'pre-wrap',
            },
        },
    ],
});
vars({ draw_hands }, child_keys);
Object.assign(globalThis, { draw_hands }, child_keys);//!!!
~~~
## Counting
~~~! javascript
keepalive();
let drawing;
const render = async () => {
    drawing?.remove();
    drawing = await bqv.draw_hands(ocx, canvas_tools.draw_text, {
        fingers_start_at_1: true,
        angle:              Number(bqv.angle_control.value) / 180 * Math.PI,
        large_arc:          Number(bqv.large_arc_control.checked),
        sweep:              Number(bqv.sweep_control.checked),
        axes:               Number(bqv.axes_control.checked),
        translated_axes:    Number(bqv.translated_axes_control.checked),
    });
};
await render();
bqv.angle_control.onchange = render;
bqv.large_arc_control.onchange = render;
bqv.sweep_control.onchange = render;
bqv.axes_control.onchange = render;
bqv.translated_axes_control.onchange = render;
bqv.cx_control.onchange = render;
bqv.cy_control.onchange = render;
sleep(0.2).then(() => { drawing?.scrollIntoView(false); bqv.angle_control.focus(); });//!!!
~~~
</bq-cell>

<bq-cell data-type="markdown">
General equation for ellipse, parameterized by $\theta$, with radii $r_x$ and $r_y$, center $(c_x, c_y)$ and rotated by angle $\phi$:
~~~! latex
\begin{pmatrix}
x \\
y \\
\end{pmatrix}
=
\begin{pmatrix}
\cos{\phi} & -\sin{\phi} \\
\sin{\phi} &  \cos{\phi} \\
\end{pmatrix}
\begin{pmatrix}
r_x \cos{\theta} \\
r_y \sin{\theta} \\
\end{pmatrix}
+
\begin{pmatrix}
c_x \\
c_y \\
\end{pmatrix}
~~~
We are given two points on an elliptical arc starting at $(x_1, y_1)$ and ending at $(x_2, y_2)$.  These correspond to a starting parameter $\theta_1$ and an ending parameter $\theta_2$.

Primed coordinates represent transformed coordinates after by rotating $-\phi$ around $(c_x, c_y)$ and translating the midpoint between $(x_1, y_1)$ and $(x_2, y_2)$ to the origin.
~~~! latex
\begin{align*}
x_1^\prime & = c_x^\prime + r_x \cos{\theta_1} \\
y_1^\prime & = c_y^\prime + r_y \sin{\theta_1} \\
\\
x_2^\prime & = c_x^\prime + r_x \cos{\theta_2} \\
y_2^\prime & = c_y^\prime + r_y \sin{\theta_2} \\
\end{align*}
~~~
The starting point $(x_1^\prime, y_1^\prime)$ and ending point at $(x_2^\prime, y_2^\prime)$ form two congruent right triangles with bases along the x-axis and hypotenuse from the origin to the point.  Call $D$ the distance between $(x_1^\prime, y_1^\prime)$ and $(x_2^\prime, y_2^\prime)$.  Each hypotenuse has length $D/2$.
~~~! latex
\begin{align*}
D^2 & = ({x_2} - {x_1})^2 + ({y_2} - {y_1})^2 \\
\end{align*}
\newline
\begin{align*}
\\
D^2/4 & = {x_1^\prime}^2 + {y_1^\prime}^2 \\
      & = {x_2^\prime}^2 + {y_2^\prime}^2 \\
\\
D^2/4 = ~ & {c_x^\prime}^2 + 2 c_x^\prime r_x \cos{\theta_1} + r_x^2 \cos^2{\theta_1} ~ + \\
          & {c_y^\prime}^2 + 2 c_y^\prime r_y \sin{\theta_1} + r_y^2 \sin^2{\theta_1} \\
\\
D^2/4 = { } & {c_x^\prime}^2 + 2 c_x^\prime r_x \cos{\theta_2} + r_x^2 \cos^2{\theta_2} ~ + \\
            & {c_y^\prime}^2 + 2 c_y^\prime r_y \sin{\theta_2} + r_y^2 \sin^2{\theta_2} \\
\end{align*}
~~~
The points $(x_1^\prime, y_1^\prime)$, the Origin $\mathcal{O}$, and $(x_2^\prime, y_2^\prime)$ are colinear, with midpoint $\mathcal{O}$.  Therefore:
~~~! latex
\begin{align*}
x_2^\prime & = - x_1^\prime\\
y_2^\prime & = - y_1^\prime\\
\end{align*}
~~~
The angle between vector $(1, 0)$ (i.e., the x-axis) and vector $((x_1^\prime-c_x^\prime)/r_x, (y_1^\prime-c_y^\prime)/r_y)$ is $\theta_1$,
and the angle between vector $((x_1^\prime-c_x^\prime)/r_x, (y_1^\prime-c_y^\prime)/r_y)$ and vector $((x_2^\prime-c_x^\prime)/r_x, (y_2^\prime-c_y^\prime)/r_y)$ is $\theta_2$.  Therefore:
~~~! latex
\gdef\VAx{1}
\gdef\VAy{0}
\gdef\VBx{\frac{x_1^\prime - c_x^\prime}{r_x}}
\gdef\VBy{\frac{y_1^\prime - c_y^\prime}{r_y}}
\gdef\VCx{\frac{x_2^\prime - c_x^\prime}{r_x}}
\gdef\VCy{\frac{y_2^\prime - c_y^\prime}{r_y}}
\begin{align*}
\cos\theta_1 & = \frac{\VBx - \VAx}
                      {\sqrt{(\VBx - \VAx)^2 + (\VBy - \VAy)^2}} \\
\\
\sin\theta_1 & = \frac{\VBy - 0}
                      {\sqrt{(\VBx - \VAx)^2 + (\VBy - \VAy)^2}} \\
\\
\cos\theta_2 & = \frac{\VCx - \VBx}
                      {\sqrt{(\VCx - \VBx)^2 + (\VCy - \VBy)^2}} \\
\\
\sin\theta_2 & = \frac{\VCy - \VBy}
                      {\sqrt{(\VCx - \VBx)^2 + (\VCy - \VBy)^2}} \\
\\
\end{align*}
~~~
Simplifying:
~~~! latex
\gdef\DENa{\sqrt{\frac{1}{r_x^2} (x_1^\prime - c_x^\prime - r_x)^2 + \frac{1}{r_y^2} (y_1^\prime - c_y^\prime)^2}}
\gdef\DENb{\sqrt{(\frac{x_2^\prime - x_1^\prime}{r_x})^2 + (\frac{y_2^\prime - y_1^\prime}{r_y})^2}}
\gdef\DENbs{\sqrt{(\frac{x_1^\prime}{r_x})^2 + (\frac{y_1^\prime}{r_y})^2}}
\begin{align*}
\cos\theta_1 & = \frac{\frac{1}{r_x} (x_1^\prime - c_x^\prime - rx)}{\DENa} \\
\\
\sin\theta_1 & = \frac{\frac{1}{r_y} (y_1^\prime - c_y^\prime)}{\DENa} \\
\\
\cos\theta_2 & = \frac{\frac{1}{r_x} (x_2^\prime - x_1^\prime)}{\DENb} \\
             & = \frac{\frac{- x_1^\prime}{r_x}}{\DENbs} \\
\\
\sin\theta_2 & = \frac{\frac{1}{r_y} (y_2^\prime - y_1^\prime)}{\DENb} \\
             & = \frac{\frac{- y_1^\prime}{r_y}}{\DENbs} \\
\\
\end{align*}
~~~
</bq-cell>
<bq-cell data-type="javascript">
</bq-cell>
</body>
</html>
